<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        button {
            margin: 0px 10px;
        }

        .loader {
            border: 10px solid #f3f3f3;
            border-radius: 50%;
            border-top: 10px solid #3498db;
            width: 50px;
            height: 50px;
            -webkit-animation: spin 2s linear infinite;
            /* Safari */
            animation: spin 2s linear infinite;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <title>Välkommen till påskäggsköparsidan!</title>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            socket = io('http://localhost:8081');
            socket.on('onConnection', (data) => {
                console.log(data)
                let session = sessionStorage.getItem('userLoggedIn')
                console.log(session)

                if (session !== null) {
                    console.log("we are here")

                    socket.emit('showEgg', sessionStorage.getItem('mongoId'))



                } else {
                    let candyList = document.getElementById('candyList')
                    let load = document.getElementById('loader')
                    h1.innerHTML = "Du är inte inloggad din n00b!"
                    candyList.remove()
                    load.remove()
                }
            })

            socket.on('showAllCandy', (candyData, sortBy) => {
                console.log('Connected to server from Customer page2')
                createList(candyData, sortBy)
            })

            socket.on('showFilteredList', (filteredData) => {

                console.log('Connected to server from Customer page')
                createList(filteredData)
            })

        })

        function showOnlyOneEgg(id) {
            socket.emit('showEgg', '5e7b2a4c30cc881860bee94f')
        }

        function createList(candyData, sortBy) {
            console.log(candyData.mongo)
            console.log(candyData.sql)
            let candyList = document.getElementById('candyList')
            candyList.innerHTML = ''
            if (candyData.sql.length < 1) {
                candyList.innerHTML = 'No candies found with this filter'
                document.getElementById('loader').innerHTML = ''
            } else {

                for (let i = 0; i < candyData.sql.length; i++) {

                    //En godiswrapper
                    let oneCandy = document.createElement('section')
                    oneCandy.setAttribute('id', candyData.sql[i].id)

                    //Namn
                    let candyName = document.createElement('div')
                    candyName.innerHTML = candyData.sql[i].name
                    oneCandy.appendChild(candyName)

                    //Kategori
                    let category = document.createElement('div')
                    category.innerHTML = candyData.sql[i].category
                    oneCandy.appendChild(category)

                    //Färg
                    let color = document.createElement('div')
                    color.innerHTML = candyData.sql[i].color
                    oneCandy.appendChild(color)

                    //Producent
                    let producer = document.createElement('div')
                    producer.innerHTML = candyData.sql[i].producer
                    oneCandy.appendChild(producer)

                    //Price
                    let price = document.createElement('div')
                    price.innerHTML = `Price: ${candyData.sql[i].price}`
                    oneCandy.appendChild(price)

                    //Ta bort -
                    let remove = document.createElement('button')
                    remove.innerHTML = '-'
                    remove.setAttribute('onclick', `removeCandy(${candyData.sql[i].id})`)
                    oneCandy.appendChild(remove)

                    //Antal
                    let amount = document.createElement('span')
                    amount.innerHTML = 'Amount : 0 '
                    for (let j = 0; j < candyData.mongo.length; j++) {

                        if (candyData.sql[i].id == candyData.mongo[j].candy_producers_id) {
                            amount.innerHTML = 'Amount : ' + candyData.mongo[j].amount
                        }

                    }
                    oneCandy.appendChild(amount)

                    //Lägg till +
                    let add = document.createElement('button')
                    add.innerHTML = '+'
                    add.setAttribute('onclick', `addCandy(${candyData.sql[i].id})`)
                    oneCandy.appendChild(add)

                    //Saldo
                    let balance = document.createElement('div')
                    balance.innerHTML = 'Balance: ' + candyData.sql[i].balance
                    oneCandy.appendChild(balance)

                    //Godisavskiljare
                    let separation = document.createElement('div')
                    separation.innerHTML = "-----------------------------------"
                    oneCandy.appendChild(separation)

                    document.getElementById('loader').innerHTML = ''
                    candyList.appendChild(oneCandy)
                }
            }
        }

        function updateList() {
            document.getElementById('candyList').innerHTML = ''
            document.getElementById('loader').innerHTML = '<div class="loader"></div>'
            let producerId = document.getElementById('producer').value
            let category = document.getElementById('category').value
            let sortBy = document.getElementById('sortBy').value
            socket.emit('getFilteredCandyList', producerId, category, sortBy, sessionStorage.getItem('mongoId'))
        }
    </script>
</head>

<body>
    <h1>Hej och välkommen till customer-sidan!</h1>
    <h2 id='customerName'></h2>

    <select id="producer" onchange="updateList()">
        <option value="0">All producers</option>
        <option value="1">Malaco</option>
        <option value="2">Fazer</option>
        <option value="3">Cloetta</option>
        <option value="4">Bassets</option>
    </select>
    <select id="category" onchange="updateList()">
        <option value="0">All categories</option>
        <option value="bar">Bars</option>
        <option value="lollipop">Lollipops</option>
        <option value="chocolate">Chocolates</option>
        <option value="liquorice">Liquorices</option>
        <option value="marshmallow">Marshmallows</option>
        <option value="toffee">Toffees</option>
    </select>
    <div>Sort by: </div>
    <select id="sortBy" onchange="updateList()">
        <option value="candy1">Name A-Z</option>
        <option value="candy2">Name Z-A</option>
        <option value="price1">Price - lowest first</option>
        <option value="price2">Price - highest first</option>
    </select>
    <div id="loader">
        <div class="loader"></div>
    </div>
    <div>-----------------------------------</div>
    <section id='candyList'></section>

    <button>Gå till konsument sidan</button>
</body>

</html>